FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

RUN apt-get update
RUN apt install -y apt-utils
RUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections && apt-get install -y -q
RUN apt install -y nano
RUN apt-get install -y software-properties-common
RUN add-apt-repository --remove ppa:george-edison55/cmake-3.x
RUN apt-get update
RUN apt-get install -y cmake git smbclient
RUN add-apt-repository universe
RUN apt-get update
RUN apt-get install -y curl python3.10 python3.10-distutils python3.10-dev python3-pip
RUN apt-get install freeglut3-dev build-essential libx11-dev libxmu-dev libxi-dev libglu1-mesa libglu1-mesa-dev -y
RUN apt-get install libssl-dev openssl -y
RUN apt-get install libbz2-dev -y
RUN apt-get install libboost-all-dev -y
RUN apt-get install ninja-build -y
RUN python3 -m pip install simple-colors --no-cache-dir
RUN apt-get install -y '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev
RUN apt-get install -y libxrender1
RUN apt-get install -y tree
RUN apt-get install -y gnuplot
RUN apt-get install -y python3-tk && \
    apt-get install -y htop  && \
    apt-get install -y sshfs && \
    apt-get install -y graphviz
RUN python3 -m pip install wheel

# TensorRT 10.x
# скачивание TRT файла доступно ТОЛЬКО РУКАМИ С САЙТА nvidia tensorrt
# cp ~/Downloads/TensorRT-10.10.0.31.Linux.x86_64-gnu.cuda-12.9.tar.gz /mnt/nvme/bigdeps/TensorRT-10.10.0.31.Linux.x86_64-gnu.cuda-12.9.tar.gz
COPY /mnt/nvme/bigdeps/TensorRT-10.10.0.31.Linux.x86_64-gnu.cuda-12.9.tar.gz /tmp/ 

RUN mkdir -p /usr/src/tensorrt && \
    tar xzf /tmp/TensorRT-10.10.0.31.Linux.x86_64-gnu.cuda-12.9.tar.gz -C /usr/src/tensorrt --strip-components=1 && \
    rm /tmp/TensorRT-*.tar.gz

RUN cd /usr/src/tensorrt/python && \
    pip install tensorrt-*-cp310-none-linux_x86_64.whl

ENV CUDAV=12.4
ENV CUDA_INCLUDE_DIRS=/usr/local/cuda-$CUDAV/targets/x86_64-linux/include/
ENV CUDA_CUDART_LIBRARY=/usr/local/cuda-$CUDAV/targets/x86_64-linux/lib/
ENV CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-$CUDAV/
ENV CUDA_HOME=/usr/local/cuda-$CUDAV
ENV CMAKE_CUDA_COMPILER=/usr/local/cuda-$CUDAV/bin/nvcc
ENV CUDACXX=/usr/local/cuda-$CUDAV/bin/nvcc
ENV PATH=/usr/local/cuda-$CUDAV/bin:$PATH
ARG TORCH_CUDA_ARCH_LIST="5.0;6.0;6.1;7.0;7.5;8.0;8.6;9.0;9.0+PTX"

ENV LD_LIBRARY_PATH="/usr/src/tensorrt/lib:$LD_LIBRARY_PATH"
ENV PATH="/usr/src/tensorrt/bin:$PATH"
ENV TENSORRT_PATH=/usr/src/tensorrt

WORKDIR /app
# python3 deps
ARG deps_file=/app/docker/patchcu124.sh
RUN --mount=type=bind,source=.,target=/app,readwrite \
    bash ${deps_file}